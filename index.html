<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Garment NFT - Full Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        pre { background-color: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
        .hidden { display: none; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; margin-top: 5px; }
        input, textarea { width: 98%; padding: 8px; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>Garment NFT</h1>

    <div id="login-section">
        <p>ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¨¼ì € êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        <button onclick="loginWithGoogle()">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
    </div>

    <div id="main-section" class="hidden">
        <hr>
        <h2>ì¸ì¦ ìƒíƒœ:</h2>
        <pre id="auth-status">ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...</pre>
        
        <hr>
        <h2>í”„ë¡œí•„ ê´€ë¦¬</h2>
        <div id="profile-section">
            <div>
                <label for="nickname-input">ë‹‰ë„¤ì„:</label>
                <input type="text" id="nickname-input" placeholder="ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div style="margin-top: 10px;">
                <label for="bio-input">ìê¸°ì†Œê°œ:</label>
                <textarea id="bio-input" rows="3" placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)"></textarea>
            </div>
            <button onclick="updateProfile()">í”„ë¡œí•„ ì €ì¥í•˜ê¸°</button>
            <pre id="profile-status">í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre>
        </div>

        <hr>
        <h2>ì§€ê°‘ ì—°ë™</h2>
        <div id="wallet-section">
            <p>ì´ì œ ë‹¹ì‹ ì˜ MetaMask ì§€ê°‘ì„ ê³„ì •ì— ì—°ê²°í•˜ì„¸ìš”.</p>
            <button onclick="linkWallet()">MetaMask ì§€ê°‘ ì—°ê²°í•˜ê¸°</button>
            <pre id="wallet-status">ì—°ê²° ëŒ€ê¸° ì¤‘...</pre>
        </div>
    </div>


    <script>
        // --- ê¸°ë³¸ ì„¤ì • ---
        const SUPABASE_URL = 'https://ssjamldabxxymustdcaw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzamFtbGRhYnh4eW11c3RkY2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODU5ODcsImV4cCI6MjA2OTg2MTk4N30.guuVLX2yI-WC9jVTKh9fzfK78so5kdsd9GJ6CqUP_Iw'; // ğŸš¨ ë°˜ë“œì‹œ ë³¸ì¸ì˜ anon í‚¤ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”!
        const BACKEND_URL = 'http://localhost:5050';

        const { createClient } = supabase;
        const mySupabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (í”„ë¡œí•„ ê´€ë ¨ ìš”ì†Œ ì¶”ê°€) ---
        const loginSection = document.getElementById('login-section');
        const mainSection = document.getElementById('main-section');
        const authStatus = document.getElementById('auth-status');
        const walletStatus = document.getElementById('wallet-status');
        const profileStatus = document.getElementById('profile-status');
        const nicknameInput = document.getElementById('nickname-input');
        const bioInput = document.getElementById('bio-input');

        let accessToken = null;

        // --- í•¨ìˆ˜ ì •ì˜ ---

        // êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘ í•¨ìˆ˜
        async function loginWithGoogle() { /* ...ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼... */ }

        // ì§€ê°‘ ì—°ë™ ë©”ì¸ í•¨ìˆ˜
        async function linkWallet() { /* ...ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼... */ }

        // --- í”„ë¡œí•„ ê´€ë¦¬ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€) ---

        // 3. ë‚´ í”„ë¡œí•„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function getProfile() {
            if (!accessToken) return;
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('í”„ë¡œí•„ ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
                
                const profile = await response.json();
                nicknameInput.value = profile.public_username;
                bioInput.value = profile.bio || '';
                profileStatus.textContent = 'í”„ë¡œí•„ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.';

            } catch (error) {
                profileStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // 4. í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
        async function updateProfile() {
            if (!accessToken) return;
            
            const newNickname = nicknameInput.value;
            const newBio = bioInput.value;
            profileStatus.textContent = 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘...';

            try {
                const response = await fetch(`${BACKEND_URL}/api/users/me/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ nickname: newNickname, bio: newBio })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
                
                profileStatus.textContent = `ğŸ‰ ì„±ê³µ!\n\n${result.message}`;
                // ì—…ë°ì´íŠ¸ ì„±ê³µ í›„, ìµœì‹  ì •ë³´ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                await getProfile();

            } catch (error) {
                profileStatus.textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }


        // --- ì¸ì¦ ìƒíƒœ ê°ì§€ ë° UI ë³€ê²½ ---
        mySupabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                loginSection.classList.add('hidden');
                mainSection.classList.remove('hidden');

                accessToken = session.access_token;
                authStatus.textContent = 'ë¡œê·¸ì¸ ì„±ê³µ!\n\n[Access Token]\n' + accessToken;
                
                try {
                    // 1. ë°±ì—”ë“œì— í”„ë¡œí•„ ë™ê¸°í™”ë¥¼ ë¨¼ì € ìš”ì²­í•©ë‹ˆë‹¤.
                    profileStatus.textContent = "ì‚¬ìš©ì í”„ë¡œí•„ ë™ê¸°í™” ì¤‘...";
                    const syncResponse = await fetch(`${BACKEND_URL}/api/users/sync-profile`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ userMetaData: session.user.user_metadata })
                    });

                    if (!syncResponse.ok) {
                        const errorResult = await syncResponse.json();
                        throw new Error(errorResult.message || 'í”„ë¡œí•„ ë™ê¸°í™” ì‹¤íŒ¨');
                    }
                    console.log("í”„ë¡œí•„ ë™ê¸°í™” ì™„ë£Œ!");

                    // 2. ë™ê¸°í™”ê°€ ì„±ê³µí•œ í›„ì—, ìµœì‹  í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                    await getProfile();

                } catch (error) {
                    profileStatus.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                    console.error('ì´ˆê¸° ì„¤ì • ì‹¤íŒ¨:', error);
                }

            } else if (event === 'SIGNED_OUT') {
                // --- ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼) ---
                loginSection.classList.remove('hidden');
                mainSection.classList.add('hidden');
                accessToken = null;
                authStatus.textContent = 'ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.';
                nicknameInput.value = '';
                bioInput.value = '';
            }
        });

        // --- ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë³µì‚¬ ---
        async function loginWithGoogle() {
            await mySupabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: 'http://localhost:5173/' }
            });
        }
        async function linkWallet() {
            walletStatus.textContent = 'ì§€ê°‘ ì—°ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤... MetaMaskë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            if (!accessToken) {
                walletStatus.textContent = 'ì˜¤ë¥˜: ë¨¼ì € ì†Œì…œ ë¡œê·¸ì¸ì„ ì™„ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }
            try {
                walletStatus.textContent = '1/3: ì„œëª…ì— í•„ìš”í•œ ë©”ì‹œì§€ë¥¼ ìš”ì²­í•˜ëŠ” ì¤‘...';
                const nonceResponse = await fetch(`${BACKEND_URL}/api/users/me/wallets/nonce`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!nonceResponse.ok) throw new Error('Nonce ìš”ì²­ ì‹¤íŒ¨');
                const { nonce } = await nonceResponse.json();
                walletStatus.textContent = '2/3: MetaMask íŒì—…ì—ì„œ ë©”ì‹œì§€ì— ì„œëª…í•´ì£¼ì„¸ìš”...';
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];
                const signature = await window.ethereum.request({ method: 'personal_sign', params: [nonce, walletAddress] });
                walletStatus.textContent = '3/3: ì„œëª… í™•ì¸ ë° ì§€ê°‘ ì—°ë™ ì¤‘...';
                const linkResponse = await fetch(`${BACKEND_URL}/api/users/me/wallets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ address: walletAddress, signature: signature })
                });
                const result = await linkResponse.json();
                if (!linkResponse.ok) throw new Error(result.message || 'ì§€ê°‘ ì—°ë™ ìµœì¢… ì‹¤íŒ¨');
                walletStatus.textContent = `ğŸ‰ ì„±ê³µ!\n\n${result.message}\nì—°ê²°ëœ ì§€ê°‘ ì£¼ì†Œ: ${result.wallet.address}`;
            } catch (error) {
                walletStatus.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                console.error(error);
            }
        }
    </script>
</body>
</html>